<template>
  <header class="pid-header">
    <div class="pid-header-inner slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
      <div class="pid-left slds-col">
        <div class="pid-brand slds-grid slds-grid_vertical-align-center">
          <span class="pid-title">Shopping Portal</span>
        </div>
      </div>
      <div class="pid-center slds-col slds-text-align_center">
        <lightning-input
          class="pid-search"
          type="search"
          placeholder="Search products or SKU"
          value={searchKey}
          onchange={onSearchChange}
          debounce="300">
        </lightning-input>
      </div>
      <div class="pid-right slds-col slds-text-align_right">
        <div class="pid-actions">
          <lightning-button-icon
            class="filter-btn"
            icon-name="utility:filterList"
            alternative-text="Filters"
            title="Filters"
            onclick={openFilterPanel}>
          </lightning-button-icon>
          <button class="cart-btn" onclick={openCart} title="Cart" aria-label="Open cart">
            Cart
            <template if:true={hasCartItems}>
              <span class="cart-badge">{cartCount}</span>
            </template>
          </button>
        </div>
      </div>
    </div>
  </header>
  <main class="pid-body">
    <div class="product-grid" onscroll={onGridScroll} data-id="productGrid" role="list">
      <template if:true={isLoading}>
        <template for:each={skeletons} for:item="s">
          <div key={s.id} class="product-card-wrapper">
            <div class="product-skeleton-card"></div>
          </div>
        </template>
      </template>
      <template if:true={products}>
        <template for:each={products} for:item="product">
          <div key={product.id} class="product-card-wrapper" role="listitem">
            <c-product-card product={product} onaddtocart={handleAddToCart} onpbeinfo={handlePbeInfo} onpbeerror={handlePbeError} onloading={handleChildLoading}></c-product-card>
          </div>
        </template>
      </template>
      <template if:true={noResults}>
        <div class="no-results">No products found.</div>
      </template>
    </div>
    <div class="load-more-placeholder" if:true={isLoadingMore}>
      <lightning-spinner alternative-text="Loading more products"></lightning-spinner>
    </div>
  </main>
  <footer class="pid-footer">
    <div class="footer-inner">Showing {products.length} of {totalSize} products</div>
  </footer>
  <template if:true={showFilterModal}>
    <section class="filter-modal" role="dialog" aria-modal="true" aria-label="Filter Products">
      <div class="filter-header">
        <h3>Filter by Product Family</h3>
        <lightning-button-icon icon-name="utility:close" alternative-text="Close" onclick={closeFilterPanel}></lightning-button-icon>
      </div>
      <div class="filter-body">
        <template for:each={availableFamilies} for:item="family">
          <div key={family.name} class="filter-option">
            <lightning-input
              type="checkbox"
              label={family.name}
              value={family.name}
              onchange={handleFamilyChange}
              checked={family.selected}>
            </lightning-input>
          </div>
        </template>
      </div>
      <div class="filter-footer">
        <lightning-button variant="neutral" label="Cancel" onclick={closeFilterPanel}></lightning-button>
        <lightning-button variant="brand" label="Apply Filters" onclick={applyFilters}></lightning-button>
      </div>
    </section>
    <div class="modal-backdrop" onclick={closeFilterPanel}></div>
  </template>
  <template if:true={showPbeModal}>
    <section class="modal modal-large" role="dialog" aria-modal="true" aria-label="Pricebook Info">
      <div class="modal-header">
        <h3>Pricebook Info</h3>
        <lightning-button-icon icon-name="utility:close" alternative-text="Close" onclick={closePbeModal}></lightning-button-icon>
      </div>
      <div class="modal-body modal-body-wide">
        <div class="product-summary">
          <h4>{modalProduct.name}</h4>
          <p><strong>SKU:</strong> {modalProduct.sku}</p>
          <p><strong>Family:</strong> {modalProduct.family}</p>
          <p><strong>Description:</strong> {modalProduct.description}</p>
          <p><strong>Displayed Price:</strong> {formattedModalPrice}</p>
        </div>
        <div class="pbe-section">
          <template if:true={pbeInfo.length}>
            <div class="pbe-details">
              <template for:each={pbeInfo} for:item="row">
                <div key={row.pricebookEntryId} class="pbe-row">
                  <div class="pbe-price">Unit Price: <strong>{row.formattedUnitPrice}</strong></div>
                  <div class="pbe-info">
                    <span>Pricebook: {row.pricebookName}</span>
                    <span>Active: {row.isActive}</span>
                    <span>SKU: {row.sku}</span>
                  </div>
                </div>
              </template>
            </div>
          </template>
          <template if:false={pbeInfo.length}>
            <div>No Pricebook info found.</div>
          </template>
        </div>
      </div>
      <div class="modal-footer">
        <lightning-button variant="neutral" label="Close" onclick={closePbeModal}></lightning-button>
        <lightning-button variant="brand" label="Add to Cart" onclick={pbeAddToCart}></lightning-button>
      </div>
    </section>
    <div class="modal-backdrop" onclick={closePbeModal}></div>
  </template>
  <template if:true={showModal}>
    <section class="modal modal-large" role="dialog" aria-modal="true" aria-label="Product Details">
      <div class="modal-header">
        <h3>{modalProduct.name}</h3>
        <lightning-button-icon icon-name="utility:close" alternative-text="Close" onclick={closeModal}></lightning-button-icon>
      </div>
      <div class="modal-body modal-body-wide">
        <p><strong>SKU:</strong> {modalProduct.sku}</p>
        <p><strong>Family:</strong> {modalProduct.family}</p>
        <p><strong>Description:</strong> {modalProduct.description}</p>
        <p><strong>Price:</strong> {formattedModalPrice}</p>
        <template if:true={modalProduct.pbes}>
          <div class="modal-pbes">
            <h4>Pricebook Entries</h4>
            <template for:each={modalProduct.pbes} for:item="pb">
              <div key={pb.pricebookEntryId} class="modal-pbe-row">
                <div>Pricebook: {pb.pricebookName}</div>
                <div>Unit Price: {pb.formattedUnitPrice}</div>
                <div>Active: {pb.isActive}</div>
              </div>
            </template>
          </div>
        </template>
      </div>
      <div class="modal-footer">
        <lightning-button variant="neutral" label="Close" onclick={closeModal}></lightning-button>
      </div>
    </section>
    <div class="modal-backdrop" onclick={closeModal}></div>
  </template>
  <template if:true={showCart}>
    <section class="cart-drawer" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="cart-header">
        <h3>Cart ({cartCount})</h3>
      </div>
      <div class="cart-body">
        <template if:true={cartItems.length}>
          <template for:each={cartItems} for:item="it">
            <div key={it.id} class="cart-item">
              <div class="cart-item-left">
                <div class="cart-item-name">{it.name}</div>
                <div class="cart-item-sku">SKU: {it.sku}</div>
              </div>
              <div class="cart-item-right">
                <div class="cart-item-price">{it.formattedPrice}</div>
                <lightning-button-icon icon-name="utility:delete" alternative-text="Remove" onclick={removeFromCart} data-id={it.id}></lightning-button-icon>
              </div>
            </div>
          </template>
        </template>
        <template if:false={cartItems.length}>
          <div class="empty-cart">Your cart is empty.</div>
        </template>
      </div>
      <div class="cart-footer">
        <lightning-button variant="neutral" label="Close" onclick={closeCart}></lightning-button>
        <lightning-button variant="brand" label="Checkout" onclick={onCheckout} disabled={isCheckoutDisabled}></lightning-button>
      </div>
    </section>
    <div class="drawer-backdrop" onclick={closeCart}></div>
  </template>
</template>