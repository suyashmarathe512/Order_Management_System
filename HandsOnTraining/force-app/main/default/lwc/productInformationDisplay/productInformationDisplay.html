<template>
  <header class="pid-header">
    <div class="pid-header-inner">
      <!-- Top row: Title and Cart -->
      <div class="pid-header-top">
        <div class="pid-left">
          <div class="pid-brand">
            <img src={cartIconUrl} alt="Cart" class="cart-icon" />
            <div>
              <span class="pid-title" style="padding: 16px 3px 14px">Shopping Portal</span>
            </div>
          </div>
        </div>
        <div class="pid-right">
          <div class="pid-actions">
            <button class="slds-button slds-button_icon slds-button_icon-border cart-btn" onclick={openCart} title="Cart" aria-label="Open cart">
              Cart
              <template if:true={hasCartItems}>
                <span class="cart-badge">{cartCount}</span>
              </template>
            </button>
          </div>
        </div>
      </div>
      <!-- Bottom row: Search and Filter -->
      <div class="pid-header-bottom">
        <template if:true={accountName}>
                <p class="account-name"><strong>Account:</strong> {accountName}</p>
              </template>
        <div class="pid-search-section">
          <div class="pid-search-container">
              <lightning-input
                class="pid-search"
                type="search"
                placeholder="Search products or SKU"
                value={searchKey}
                onchange={onSearchChange}
                onkeypress={handleSearchKeyPress}>
              </lightning-input>
          </div>
            <div class="filter-container">
              <lightning-button-icon
                class={filterBtnClass}
                icon-name="utility:filterList"
                alternative-text="Filters"
                title="Filters"
                onclick={openFilterPanel}>
              </lightning-button-icon>
              <template if:true={hasActiveFilters}>
                <div class="filter-indicator"></div>
              </template>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="pid-body">
    <div class="product-grid" onscroll={onGridScroll} data-id="productGrid" role="list">
      <template if:true={isLoading}>
        <template for:each={skeletons} for:item="s">
          <div key={s.id} class="product-card-wrapper">
            <div class="product-skeleton-card"></div>
          </div>
        </template>
      </template>

      <template if:true={products}>
        <template for:each={products} for:item="product">
          <div key={product.id} class="product-card-wrapper" role="listitem">
            <c-product-card product={product} 
              record-id={recordId} 
              onaddtocart={handleAddToCart}
              onremovefromcart={removeFromCart}
              onpbeinfo={handlePbeInfo} 
              onpbeerror={handlePbeError} 
              onloading={handleChildLoading}>
            </c-product-card>
          </div>
        </template>
      </template>

      <template if:true={noResults}>
        <div class="no-results">No products found.</div>
      </template>
    </div>

    <template if:true={isLoadingMore}>
      <div class="load-more-placeholder">
        <lightning-spinner alternative-text="Loading more products"></lightning-spinner>
      </div>
    </template>
  </main>

  <footer class="pid-footer">
    <div class="footer-inner">Showing {products.length} of {totalSize} products</div>
  </footer>

  <template if:true={showFilterModal}>
    <section class="filter-modal" role="dialog" aria-modal="true" aria-label="Filter Products">
      <div class="filter-header">
        <h3>Filter by Product Family</h3>
        <lightning-button-icon icon-name="utility:close" alternative-text="Close" onclick={closeFilterPanel}></lightning-button-icon>
      </div>
      <div class="filter-body">
        <template for:each={availableFamilies} for:item="family">
          <div key={family.name} class="filter-option">
            <lightning-input
              type="checkbox"
              label={family.name}
              value={family.name}
              onchange={handleFamilyChange}
              checked={family.selected}>
            </lightning-input>
          </div>
        </template>
      </div>
      <div class="filter-footer">
        <lightning-button variant="neutral" label="Cancel" onclick={closeFilterPanel}></lightning-button>
        <lightning-button variant="brand" label="Apply Filters" onclick={applyFilters}></lightning-button>
      </div>
    </section>
    <div class="modal-backdrop" onclick={closeFilterPanel}></div>
  </template>

  <template if:true={showPbeModal}>
    <section class="modal modal-large" role="dialog" aria-modal="true" aria-label="Pricebook Info">
      <div class="modal-header">
        <h3><strong>Pricebook Info of {modalProduct.name} </strong></h3>
        <lightning-button-icon icon-name="utility:close" alternative-text="Close" onclick={closePbeModal}></lightning-button-icon>
      </div>
      <div class="modal-body modal-body-wide">
        <div class="product-summary">
          <h4>{modalProduct.name}</h4>
          <p><strong>SKU:</strong> {modalProduct.sku}</p>
          <p><strong>Family:</strong> {modalProduct.family}</p>
          <p><strong>Description:</strong> {modalProduct.description}</p>
          <p><strong>Displayed Price:</strong> {formattedModalPrice}</p>
        </div>
        <div class="pbe-section">
          <template if:true={pbeInfo.length}>
            <div class="pbe-details">
              <template for:each={pbeInfo} for:item="row">
                <div key={row.pricebookEntryId} class="pbe-row">
                  <div class="pbe-price">Unit Price: <strong>{row.formattedUnitPrice}</strong></div>
                  <div class="pbe-info">
                    <span>Active: {row.isActive}</span>
                    <span>SKU: {row.sku}</span>
                  </div>
                </div>
              </template>
            </div>
          </template>
          <template if:false={pbeInfo.length}>
            <div>No Pricebook info found.</div>
          </template>
        </div>
      </div>
      <div class="modal-footer">
        <lightning-button variant="neutral" label="Close" onclick={closePbeModal}></lightning-button>
        <lightning-button variant="brand" label="Add to Cart" onclick={pbeAddToCart}></lightning-button>
      </div>
    </section>
    <div class="modal-backdrop" onclick={closePbeModal}></div>
  </template>

  <template if:true={showModal}>
    <section class="modal modal-large" role="dialog" aria-modal="true" aria-label="Product Details">
      <div class="modal-header">
        <h3>{modalProduct.name}</h3>
        <lightning-button-icon icon-name="utility:close" alternative-text="Close" onclick={closeModal}></lightning-button-icon>
      </div>
      <div class="modal-body modal-body-wide">
        <p><strong>SKU:</strong> {modalProduct.sku}</p>
        <p><strong>Family:</strong> {modalProduct.family}</p>
        <p><strong>Description:</strong> {modalProduct.description}</p>
        <p><strong>Price:</strong> {formattedModalPrice}</p>
        <template if:true={modalProduct.pbes}>
          <div class="modal-pbes">
            <h4>Pricebook Entries</h4>
            <template for:each={modalProduct.pbes} for:item="pb">
              <div key={pb.pricebookEntryId} class="modal-pbe-row">
                <div>Pricebook: {pb.pricebookName}</div>
                <div>Unit Price: {pb.formattedUnitPrice}</div>
                <div>Active: {pb.isActive}</div>
              </div>
            </template>
          </div>
        </template>
      </div>
      <div class="modal-footer">
        <lightning-button variant="neutral" label="Close" onclick={closeModal}></lightning-button>
      </div>
    </section>
    <div class="modal-backdrop" onclick={closeModal}></div>
  </template> 
  <template if:true={showCart}>
    <section class="cart-drawer" role="dialog" aria-modal="true" aria-label="Cart">
      <div class="cart-header">
        <h3>Cart ({cartCount})</h3>
      </div>
      <div class="cart-body">
        <template if:true={allCartItems.length}>
          <template for:each={allCartItems} for:item="item">
            <div key={item.id} class="cart-item">
              <div class="cart-item-left">
                <div class="cart-item-name">{item.name}</div>
                <template if:true={item.qty}>
                  <div class="cart-item-quantity">Qty: {item.qty}</div>
                </template>
                <template if:true={item.productCode}>
                  <div class="cart-item-code">Code: {item.productCode}</div>
                </template>
              </div>
              <div class="cart-item-right">
                <div class="cart-item-price">{item.formattedPrice}</div>
                <lightning-button-icon icon-name="utility:delete" alternative-text="Remove" onclick={removeItem} data-id={item.id} data-source={item.source}></lightning-button-icon>
              </div>
            </div>
          </template>
        </template>

        <template if:false={allCartItems.length}>
          <div class="empty-cart">Your cart is empty.</div>
        </template>
      </div>
      <div class="cart-footer">
        <lightning-button variant="neutral" label="Close" onclick={closeCart}></lightning-button>
        <lightning-button variant="brand" label="Save Cart to Draft" onclick={saveCartToDraft} disabled={isCheckoutDisabled}></lightning-button>
        <lightning-button variant="brand" label="Checkout" onclick={onCheckout} disabled={isCheckoutDisabled}></lightning-button>
      </div>
    </section>
    <div class="drawer-backdrop" onclick={closeCart}></div>
  </template>
</template>
